# Partie I Dockerisation de Postgres 

Pour permettre à `pgAdmin4` de communiquer avec le conteneur PostgreSQL via un réseau Docker, voici comment procéder :

1. **Créer un réseau Docker** (si ce n'est pas déjà fait) :
   Ce réseau Docker permettra aux conteneurs de communiquer entre eux par leur nom de service.

   ```bash
   docker network create postgres-network
   ```

2. **Lancer le conteneur PostgreSQL :**
   Utilisez la commande suivante pour lancer PostgreSQL sur le réseau Docker créé :

   ```bash
   docker run -d \
   --name postgres-db \
   -e POSTGRES_PASSWORD=MonMotDePasse \
   -e POSTGRES_USER=MonUtilisateur \
   -e POSTGRES_DB=MaBaseDeDonnees \
   -v pgdata:/var/lib/postgresql/data \
   --network=postgres-network \
   postgres:latest
   ```

3. **Lancer le conteneur `pgAdmin4` sur le même réseau :**
   Pour que `pgAdmin4` puisse communiquer avec PostgreSQL, il doit être sur le même réseau Docker. Utilisez la commande suivante pour lancer `pgAdmin4` :

   ```bash
   docker run -d \
   --name pgadmin4 \
   -e PGADMIN_DEFAULT_EMAIL=admin@example.com \
   -e PGADMIN_DEFAULT_PASSWORD=admin \
   -p 8080:80 \
   --network=postgres-network \
   dpage/pgadmin4
   ```

   Voici ce que chaque option fait :
   - `--name pgadmin4` : Donne un nom au conteneur `pgAdmin4`.
   - `-e PGADMIN_DEFAULT_EMAIL=admin@example.com` : Définit l'email par défaut pour se connecter à `pgAdmin4`.
   - `-e PGADMIN_DEFAULT_PASSWORD=admin` : Définit le mot de passe par défaut pour se connecter à `pgAdmin4`.
   - `-p 8080:80` : Expose `pgAdmin4` sur le port 8080 de votre machine hôte.
   - `--network=postgres-network` : Associe le conteneur `pgAdmin4` au même réseau que PostgreSQL.

4. **Accéder à `pgAdmin4` :**
   Ouvrez votre navigateur et accédez à `http://localhost:8080`. Connectez-vous avec l'email et le mot de passe définis dans les variables d'environnement.

5. **Configurer une connexion à PostgreSQL dans `pgAdmin4` :**
   - Dans *pgAdmin4*, ajoutez un nouveau serveur.
   - Dans l'onglet "General", donnez un nom à la connexion.
   - Dans l'onglet "Connection", entrez les détails suivants :
     - `Host name/address`: `postgres-db` (c'est le nom du conteneur PostgreSQL sur le réseau).
     - `Port`: `5432`
     - `Maintenance database`: `postgres`
     - `Username`: `postgres`
     - `Password`: `test123++`
   - Cliquez sur "Save".

Maintenant, *pgAdmin4* devrait pouvoir se connecter au conteneur PostgreSQL en utilisant le nom *postgres* sur le réseau Docker partagé. Aucune configuration supplémentaire de sous-réseau n'est nécessaire, car Docker gère automatiquement l'adressage IP entre les conteneurs sur le même réseau.

# Partie II Orchestration de Posgres avec Kubernetes

**Note:** Nous supposons que Pgadmin 4 est installé
**Note:** il faut arrêter également le conteneur postgres qui tourne sur 5432

Pour utiliser le mot de passe `test123++`, voici comment ajuster le fichier `postgres-secret.yaml` :

1. **Encoder le mot de passe en base64 :**

   Utilisez la commande suivante pour encoder le mot de passe *test123++* en base64 :

   ```bash
   echo -n "test123++" | base64
   ```

   Le résultat sera : *dGVzdDEyMysr*

2. **Mettre à jour le fichier `postgres-secret.yaml` :**

## 1. Créer le secret qui stocke le mot de passe 

Remplacez le contenu du fichier *postgres-secret.yaml* avec le mot de passe encodé.

   ```yaml
   apiVersion: v1
   kind: Secret
   metadata:
     name: postgres-secret
   type: Opaque
   data:
     POSTGRES_PASSWORD: dGVzdDEyMysr
   ```

Après avoir fait cette mise à jour, vous pouvez appliquer le fichier YAML comme mentionné précédemment avec :

```bash
kubectl apply -f postgres-secret.yaml
```

Cela garantira que le mot de passe *test123++* est utilisé correctement dans votre déploiement PostgreSQL sur Kubernetes.


### 2. **Créer le ConfigMap pourle stockge des paramètres**

Créez un fichier *postgres-configmap.yaml* pour les configurations générales.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-configmap
data:
  POSTGRES_DB: "MaBaseDeDonnees"
  POSTGRES_USER: "MonUtilisateur"
```

### 3. **Créer le Persistent Volume (PV) et Persistent Volume Claim (PVC)**

Créez un fichier *postgres-pv-pvc.yaml* pour définir le stockage persistant.

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /mnt/data/postgres  # Chemin sur le nœud hôte

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

### 4. **Créer le Deployment avec 4 réplicas**

Créez un fichier *postgres-deployment.yaml* pour définir le déploiement Kubernetes.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-deployment
spec:
  replicas: 4
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:latest
        ports:
        - containerPort: 5432
        envFrom:
        - configMapRef:
            name: postgres-configmap
        env:
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: POSTGRES_PASSWORD
        volumeMounts:
        - mountPath: /var/lib/postgresql/data
          name: postgres-storage
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: postgres-pvc
```

### 5. **Créer le Service pour exposer PostgreSQL**

Créez un fichier *postgres-service.yaml* pour définir le service Kubernetes qui exposera PostgreSQL.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
  type: LoadBalancer  # ou ClusterIP si vous n'avez pas besoin d'un LoadBalancer externe
```

### 6. **Appliquer les fichiers YAML**

Appliquez tous les fichiers pour créer le Secret, ConfigMap, PV, PVC, Deployment, et Service.

```bash
kubectl apply -f postgres-secret.yaml
kubectl apply -f postgres-configmap.yaml
kubectl apply -f postgres-pv-pvc.yaml
kubectl apply -f postgres-deployment.yaml
kubectl apply -f postgres-service.yaml
```

### 7. **Vérifier que tout est en cours d'exécution**

Vérifiez que les Pods, le Service, et les volumes sont correctement créés et en cours d'exécution.

```bash
kubectl get pods
kubectl get svc
kubectl get pv
kubectl get pvc
```

### 8. **Accéder à PostgreSQL via pgadmin4**

Si vous avez un ClusterIP, vous pouvez faire un port-forward pour accéder à PostgreSQL depuis votre machine hôte.
```bash
kubectl port-forward svc/postgres-service 5432:5432
```
Cette commande redirige le port *5432* de votre machine hôte vers le port *5432* du service PostgreSQL dans Kubernetes.

Maintenant que PostgreSQL est accessible depuis votre machine hôte, configurez pgAdmin4 :

- Ouvrez pgAdmin4.
- Ajoutez un nouveau serveur.
- Dans l'onglet "General", donnez un nom à la connexion.
- Dans l'onglet "Connection", entrez les détails suivants :
- Host name/address: localhost (si vous utilisez kubectl port-forward) ou l'IP/nœud externe attribué si vous utilisez un LoadBalancer ou NodePort.
- Port: 5432
- Maintenance database: MaBaseDeDonnees
- Username: MonUtilisateur
- Password: test123++
- Cliquez sur "Save".


**Remarque:** 

Si vous préférez exposer directement (autre manière mais optionelle) le service en tant que *NodePor*t pour qu'il soit accessible via l'IP de votre nœud Kubernetes, modifiez le service :

```yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres-service
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
      nodePort: 30007  # Choisissez un port dans la plage 30000-32767
  type: NodePort

```
**Appliquez ce fichier YAML :**

```bash
kubectl apply -f postgres-service.yaml
```
Ensuite, utilisez *l'IP de votre nœud Kubernetes* et *le port 30007* pour configurer la connexion dans pgAdmin4.

Après avoir configuré pgAdmin4, testez la connexion pour vous assurer que vous pouvez accéder à votre instance PostgreSQL déployée sur Kubernetes.

Ces étapes devraient vous permettre d'accéder à PostgreSQL à partir de pgAdmin4 et de gérer votre base de données comme si elle était locale.
