D'accord, commençons par le développement complet du microservice `AccountsService`, y compris la création des fichiers Docker et Docker Compose, ainsi que la configuration de SendGrid.

### Étape 1 : Structure du projet

Voici la structure de base du projet `AccountsService` :

```
/AccountsService
    /Controllers
        AccountController.cs
        UserController.cs
    /Models
        Account.cs
        EmailMessage.cs
        LoginRequest.cs
        User.cs
        AccountsDbContext.cs
    /Services
        AccountService.cs
        EmailService.cs
        IEmailService.cs
        IJwtTokenService.cs
        JwtTokenService.cs
        UserService.cs
    /Utils
        SendGridSettings.cs
    Program.cs
    appsettings.json
    Dockerfile
    docker-compose.yml
```

#### Models: 
**Acount:**
``` Charp
namespace AccountsService.Models;

public class Account
{
    public int Id { get; set; }
    public string AccountNumber { get; set; }
    public decimal Balance { get; set; }
    public int UserId { get; set; }
    public User User { get; set; }
}

```
**EmailMessage:**

```CSharp
using System.ComponentModel.DataAnnotations;

namespace AccountsService.Models;
   
    public class EmailMessage
    {
            [Key]
            public int Id { get; set; }
            public string To { get; set; }
            public string Subject { get; set; }
            public string Content { get; set; }
    }

```
``` CSharp

namespace AccountsService.Models
{
    public class LoginRequest
    {
        public string UserName { get; internal set; }
        public string Password { get; internal set; }
    }
}
```
``` CSharp
namespace AccountsService.Models;

public class User
{
    public User()
    {
        Accounts = new HashSet<Account>(); 
    }

    public int Id { get; set; }
    public string UserName { get; set; }
    public string Password { get; set; }
    public string Email { get; set; }
    public string Role { get; set; }
    public ICollection<Account> Accounts { get; set; }

}

```

#### Utils: 

**EmailMessage:**

``` CSharp
namespace AccountsService.Utils
{
    public class EmailMessage
    {
            public string To { get; set; }
            public string Subject { get; set; }
            public string Content { get; set; }
        
    }
}
```
**SendGridSettings:**
``` CSharp
namespace AccountsService.Utils
{
    public class SendGridSettings
    {
        public string ApiKey { get; set; }
        public string FromEmail { get; set; }
        public string FromName { get; set; }
    }
}
```
#### Services: 
**AccountService:**
``` CSharp
using AccountsService.Models;

namespace AccountsService.Services;

public class AccountService
{
    private readonly AccountsDbContext _context;

    public AccountService(AccountsDbContext context)
    {
        _context = context;
    }

    public async Task<Account> GetAccountById(int id)
    {
        return await _context.Accounts.FindAsync(id);
    }

    public async Task<Account> CreateAccount(Account account)
    {
        _context.Accounts.Add(account);
        await _context.SaveChangesAsync();
        return account;
    }

    public async Task UpdateAccount(Account account)
    {
        _context.Accounts.Update(account);
        await _context.SaveChangesAsync();
    }

    public async Task DeleteAccount(int id)
    {
        var account = await _context.Accounts.FindAsync(id);
        if (account != null)
        {
            _context.Accounts.Remove(account);
            await _context.SaveChangesAsync();
        }
    }
}

```
**EmailService:**
``` CSharp
using Microsoft.Extensions.Options;
using SendGrid.Helpers.Mail;
using SendGrid;
using AccountsService.Utils;
using AccountsService.Services;

namespace AccountsService.Services;

public class EmailService : IEmailService
{
    private readonly SendGridSettings _sendGridSettings;

    public EmailService(IOptions<SendGridSettings> sendGridSettings)
    {
        _sendGridSettings = sendGridSettings.Value;
    }

    async public Task SendEmailAsync(AccountsService.Models.EmailMessage emailMessage)
    { 
        var client = new SendGridClient(_sendGridSettings.ApiKey);
        var from = new EmailAddress(_sendGridSettings.FromEmail, _sendGridSettings.FromName);
        var to = new EmailAddress(emailMessage.To);
        var msg = MailHelper.CreateSingleEmail(from, to, emailMessage.Subject, emailMessage.Content, emailMessage.Content);

        await client.SendEmailAsync(msg);
    }
}

```
**IEmailService:**
``` CSharp
using AccountsService.Models;

namespace AccountsService.Services
{
    public interface IEmailService
    {
        Task SendEmailAsync(EmailMessage emailMessage);
    }
}

```
**IJwtTokenService:**
``` CSharp
namespace AccountsService.Services;

using AccountsService.Models;
public interface IJwtTokenService
{
    string GenerateToken(User user);
}


```
**JwtTokenService:**
``` CSharp
namespace AccountsService.Services;

using System;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;
using Microsoft.IdentityModel.Tokens;
using AccountsService.Models;
using AccountsService.Services;

public class JwtTokenService : IJwtTokenService
    {
        private readonly string _secretKey;
        private readonly string _issuer;
        private readonly string _audience;

        public JwtTokenService(string secretKey, string issuer, string audience)
        {
            _secretKey = secretKey;
            _issuer = issuer;
            _audience = audience;
        }

    public string GenerateToken(User user)
    {
        var claims = new[]
           {
                new Claim("User", user.UserName),
                new Claim("Email", user.Email),
                new Claim("Role", user.Role),
                new Claim("Jti", Guid.NewGuid().ToString())
            };

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_secretKey));
        var credentials = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            _issuer,
            _audience,
            claims,
            expires: DateTime.Now.AddHours(1),
            signingCredentials: credentials);

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}
```
**UserService:**
``` CSharp
using AccountsService.Models;
using Microsoft.EntityFrameworkCore;

namespace AccountsService.Services;

public class UserService
{

    private readonly AccountsDbContext _context;
    private readonly IJwtTokenService _jwtTokenService;
    private readonly IEmailService _emailService;

    public UserService(AccountsDbContext context, IJwtTokenService jwtTokenService,IEmailService emailService)
    {
        _context = context;
        _jwtTokenService = jwtTokenService;
        _emailService = emailService;
    }

    public async Task<User> RegisterUser(User user)
    {
        _context.Users.Add(user);

        var emailMessage = new EmailMessage
        {
            To = user.Email,
            Subject = "Welcome to Banking System",
            Content = "Your registration was successful."
        };

        await _emailService.SendEmailAsync(emailMessage);

        await _context.SaveChangesAsync();

        return user;
    }

    public async Task<string> AuthenticateUser(LoginRequest loginRequest)
    {
        var user = await _context.Users
            .FirstOrDefaultAsync(u => u.UserName == loginRequest.UserName && u.Password == loginRequest.Password);

        if (user == null) return null;

        return _jwtTokenService.GenerateToken(user);
    }

    public async Task<User> GetUserById(int id)
    {
        return await _context.Users.FindAsync(id);
    }
    
}

```

#### Controllers: 

**AccountController:**
```CSharp 
using AccountsService.Models;
using AccountsService.Services;
using Microsoft.AspNetCore.Mvc;

namespace AccountsService.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AccountController : ControllerBase
{
    private readonly AccountService _accountService;

    public AccountController(AccountService accountService)
    {
        _accountService = accountService;
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetAccount(int id)
    {
        var account = await _accountService.GetAccountById(id);
        if (account == null) return NotFound();
        return Ok(account);
    }

    [HttpPost]
    public async Task<IActionResult> CreateAccount([FromBody] Account account)
    {
        var createdAccount = await _accountService.CreateAccount(account);
        return CreatedAtAction(nameof(GetAccount), new { id = createdAccount.Id }, createdAccount);
    }

    [HttpPut("{id}")]
    public async Task<IActionResult> UpdateAccount(int id, [FromBody] Account account)
    {
        if (id != account.Id) return BadRequest();
        await _accountService.UpdateAccount(account);
        return NoContent();
    }

    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteAccount(int id)
    {
        await _accountService.DeleteAccount(id);
        return NoContent();
    }
}


```
**UserController:**
```CSharp 
using Microsoft.AspNetCore.Mvc;
using AccountsService.Services;
using AccountsService.Models;

namespace AccountsService.Controllers;

[ApiController]
[Route("api/[controller]")]
public class UserController : ControllerBase
{
    private readonly UserService _userService;

    public UserController(UserService userService)
    {
        _userService = userService;
    }

    [HttpPost("register")]
    public async Task<IActionResult> Register([FromBody] User user)
    {
        var createdUser = await _userService.RegisterUser(user);
        return CreatedAtAction(nameof(GetUser), new { id = createdUser.Id }, createdUser);
        
    }

    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginRequest loginRequest)
    {
        var token = await _userService.AuthenticateUser(loginRequest);
        if (token == null) return Unauthorized();
        return Ok(token);
       
    }

    [HttpGet("{id}")]
    public async Task<IActionResult> GetUser(int id)
    {
         var user = await _userService.GetUserById(id);
         if (user == null) return NotFound();
         return Ok(user);    
    }
}
```

### Étape 2 : Fichiers de configuration

#### `appsettings.json`

Créez un fichier `appsettings.json` avec le contenu suivant :

```json
{
  "ConnectionStrings": {
    "BankingDbContext": "Server=your_sql_server;Database=AccountsDB;User Id=your_user;Password=your_password;"
  },
  "Jwt": {
    "SecretKey": "your_secret_key",
    "Issuer": "your_issuer",
    "Audience": "your_audience"
  },
  "SendGrid": {
    "ApiKey": "your_sendgrid_api_key",
    "FromEmail": "your_email@example.com",
    "FromName": "Your Name"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

### Étape 3 : Configuration de SendGrid

1. **Inscription et obtention de la clé API SendGrid :**

   - Allez sur [SendGrid](https://sendgrid.com/).
   - Créez un compte ou connectez-vous.
   - Naviguez vers l'onglet **API Keys** sous **Settings**.
   - Cliquez sur **Create API Key**, nommez votre clé et donnez-lui les autorisations nécessaires.
   - Une fois créée, copiez la clé API et collez-la dans `appsettings.json` sous `"SendGrid": { "ApiKey": "your_sendgrid_api_key" }`.

### Étape 4 : Dockerfile

Créez un fichier `Dockerfile` à la racine du projet avec le contenu suivant :

```Dockerfile
# Utiliser l'image officielle .NET SDK pour la construction de l'application
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copier le fichier .csproj et restaurer les dépendances
COPY *.csproj ./
RUN dotnet restore

# Copier le reste des fichiers et construire l'application
COPY . .
RUN dotnet publish -c Release -o /app

# Utiliser l'image officielle .NET Runtime pour exécuter l'application
FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app .

# Exposer le port 80
EXPOSE 80

# Définir le point d'entrée de l'application
ENTRYPOINT ["dotnet", "AccountsService.dll"]
```

### Étape 5 : Docker Compose

Créez un fichier `docker-compose.yml` à la racine du projet avec le contenu suivant :

```yaml
version: '3.8'

services:
  accountsservice:
    build: .
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__BankingDbContext:Server=DESKTOP-463V422\\SERVER2024;Database=AccountsDB;TrustServerCertificate=True;Trusted_Connection=True;MultipleActiveResultSets=true;
      - Jwt__SecretKey=p2jF2oD1Tz8Qh9XvU3rKr8C0Nf7L2kB6W4mP5oD3Lr7Jq8WzT0x1B2dE3F4G5H6
      - Jwt__Issuer=https://api.bankingsystem.com
      - Jwt__Audience=https://client.bankingsystem.com
      - SendGridSettings__ApiKey=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
      - SendGridSettings__FromEmail=me780411@gmail.com
      - SendGridSettings__FromName=Test Sender

```

### Étape 6 : Instructions de construction et d'exécution

1. **Construire l'image Docker :**

   Ouvrez un terminal dans le répertoire du projet et exécutez :

   ```bash
   docker-compose build
   ```

2. **Démarrer le conteneur :**

   Après avoir construit l'image, exécutez :

   ```bash
   docker-compose up
   ```

### Conclusion

En suivant ces étapes, vous avez créé un microservice `AccountsService` en utilisant .NET, configuré pour envoyer des emails avec SendGrid, sécurisé avec JWT, et prêt à être exécuté dans des conteneurs Docker.

Si vous avez des questions ou si vous avez besoin d'aide pour les étapes suivantes, faites-le moi savoir !
