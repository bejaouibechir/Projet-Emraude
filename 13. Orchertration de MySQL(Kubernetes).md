# Deploiement d'un cluster MySQL Kubernetes 

Voici un guide complet pour déployer MySQL sur un cluster Kubernetes, avec les étapes de résolution des problèmes (troubleshooting) incluses.

---

## **Guide Complet pour Déployer MySQL sur un Cluster Kubernetes**

### **1. Préparation**

Avant de commencer, assurez-vous que vous avez un cluster Kubernetes fonctionnel et configuré, ainsi qu'un accès à `kubectl`. Vous devez également avoir installé MySQL Workbench sur votre machine locale pour tester la connexion à la base de données.

### **2. Créer un Secret pour le mot de passe root MySQL**

Le mot de passe root sera stocké de manière sécurisée dans un Secret Kubernetes.

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
data:
  mysql-root-password: cGFzc3dvcmQ=  # Remplacez par votre propre mot de passe encodé en base64
```

Créez le Secret en exécutant :

```bash
kubectl apply -f mysql-secret.yaml
```

### **3. Créer un ConfigMap pour les paramètres MySQL**

Définissez un ConfigMap pour les paramètres de base de MySQL, tels que la base de données initiale, l'utilisateur et le mot de passe.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-configmap
data:
  MYSQL_DATABASE: mydatabase
  MYSQL_USER: user1
  MYSQL_PASSWORD: user1password
```

Appliquez le ConfigMap :

```bash
kubectl apply -f mysql-configmap.yaml
```

### **4. Créer un Persistent Volume (PV) et Persistent Volume Claim (PVC)**

Définissez le stockage persistant pour votre base de données MySQL.

**Persistent Volume :**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/mnt/data"
```

**Persistent Volume Claim :**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
```

Appliquez ces fichiers YAML :

```bash
kubectl apply -f mysql-pv.yaml
kubectl apply -f mysql-pvc.yaml
```

### **5. Déploiement MySQL avec 4 réplicas**

Créez un déploiement Kubernetes pour gérer MySQL avec plusieurs réplicas.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
spec:
  replicas: 4
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password
        - name: MYSQL_DATABASE
          valueFrom:
            configMapKeyRef:
              name: mysql-configmap
              key: MYSQL_DATABASE
        - name: MYSQL_USER
          valueFrom:
            configMapKeyRef:
              name: mysql-configmap
              key: MYSQL_USER
        - name: MYSQL_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: mysql-configmap
              key: MYSQL_PASSWORD
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
```

Appliquez le déploiement :

```bash
kubectl apply -f mysql-deployment.yaml
```

### **6. Exposer MySQL via un Service**

Créez un service Kubernetes pour exposer MySQL aux autres services ou à l'extérieur du cluster.

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  selector:
    app: mysql
  ports:
    - protocol: TCP
      port: 3306
      targetPort: 3306
  type: LoadBalancer  # Vous pouvez utiliser ClusterIP si vous ne souhaitez pas l'exposer à l'extérieur.
```

Appliquez le service :

```bash
kubectl apply -f mysql-service.yaml
```

### 7.Vérification des permissions de l'utilisateur MySQL
Il est possible que l'utilisateur *user1* ne soit pas configuré pour accepter des connexions depuis localhost ou 127.0.0.1. Pour corriger cela :

```bash
kubectl exec -it <pod_name> -- bash
```
Remplacez *<pod_name>* par le nom d'un des pods MySQL.

Une fois dans le pod, connectez-vous à MySQL en tant que root :

```bash
mysql -u root
```

Accordez à *user1* l'accès depuis localhost ou 127.0.0.1 :


GRANT ALL PRIVILEGES ON *.* TO 'user1'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON *.* TO 'user1'@'127.0.0.1' IDENTIFIED BY 'password';
FLUSH PRIVILEGES;

Redémarrer MySQL:

```bash
kubectl delete pod <pod_name>
```




### **7. Se connecter à MySQL depuis MySQL Workbench**

**Port-forwarding (si nécessaire) :**

Si votre service est de type `ClusterIP`, vous devez configurer un port-forward pour accéder à MySQL depuis votre machine locale :

```bash
kubectl port-forward svc/mysql-service 3306:3306
```

**Configurer la connexion dans MySQL Workbench :**

1. Ouvrez MySQL Workbench.
2. Cliquez sur `+` pour créer une nouvelle connexion.
3. Configurez les paramètres comme suit :
   - Hostname: `localhost` (ou l'IP externe si vous utilisez un LoadBalancer)
   - Port: `3306`
   - Username: `root`
   - Password: Utilisez le mot de passe défini dans le Secret.
4. Testez la connexion.

### **8. Troubleshooting : Résolution des Problèmes Communs**

#### **Erreur 1045 (Access Denied)**
Si vous obtenez une erreur `Access Denied`, vérifiez le mot de passe root et les permissions de l'utilisateur :

- Vérifiez le Secret pour vous assurer que le mot de passe root est correct.
- Si nécessaire, réinitialisez le mot de passe root en suivant les étapes décrites dans le guide.

#### **Problèmes de Connexion avec MySQL Workbench**
- **Port-forwarding** : Assurez-vous que le port-forwarding est configuré correctement si vous utilisez `ClusterIP`.
- **Service non accessible** : Vérifiez l'état du service avec `kubectl get svc mysql-service` et assurez-vous qu'il est correctement configuré.

#### **Pod Bloqué en "ContainerCreating"**
- **Vérifiez les événements du pod** : Utilisez `kubectl describe pod <pod_name>` pour voir les erreurs éventuelles.
- **Problèmes de PVC** : Assurez-vous que le PVC est bien `Bound` et que le volume est monté correctement.

### **9. Redémarrer les Pods MySQL**

Si vous avez besoin de redémarrer les pods MySQL, vous pouvez simplement les supprimer, et Kubernetes se chargera de les recréer automatiquement :

```bash
kubectl delete pod <pod_name>
```

Vérifiez ensuite que les nouveaux pods sont correctement démarrés :

```bash
kubectl get pods
```

Ce guide devrait vous permettre de déployer MySQL sur Kubernetes et de résoudre les problèmes courants que vous pourriez rencontrer. 
