# Créer un Projet Web API en .NET 8(GraphQL integré + ODATA)




**Note:** Ajoutez les packages suivants via le NuGet Package Manager :

```shell
dotnet add package HotChocolate.AspNetCore --version 13.0.1
dotnet add package HotChocolate.Data.EntityFramework --version 13.0.1
dotnet add package Microsoft.EntityFrameworkCore.InMemory --version 8.0.0
dotnet add package Microsoft.EntityFrameworkCore.Design --version 8.0.0
```

### 2. Configurer le Projet (`.csproj`)

Voici à quoi devrait ressembler votre fichier `GraphQLFirmApi.csproj` :

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="HotChocolate.AspNetCore" Version="13.0.1" />
    <PackageReference Include="HotChocolate.Data.EntityFramework" Version="13.0.1" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />
  </ItemGroup>

</Project>
```

### 3. Configurer le Fichier `launchSettings.json`

Voici le contenu de `launchSettings.json` :

```json
{
  "profiles": {
    "GraphQLFirmApi": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "https://localhost:5001;http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

### 4. Modélisation des Entités

Dans un dossier `Models`, créez les classes `Firm`, `Department`, et `Employee` :

```csharp
public class Firm
{
    public string Id { get; set; }
    public string Name { get; set; }
    public ICollection<Department> Departments { get; set; }
}

public class Department
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Location { get; set; }
    public string FirmId { get; set; }
    public Firm Firm { get; set; }
    public ICollection<Employee> Employees { get; set; }
}

public class Employee
{
    public string Id { get; set; }
    public string Name { get; set; }
    public int Age { get; set; }
    public string Email { get; set; }
    public string Address { get; set; }
    public string DepartmentId { get; set; }
    public string JobTitle { get; set; }
    public string ManagerId { get; set; }
    public Employee Manager { get; set; }
    public Department Work { get; set; }
    public ICollection<Employee> Team { get; set; } = new List<Employee>();
}
```

### 5. Configuration de la Base de Données en Mémoire

Ajoutez un fichier `AppDbContext.cs` dans le dossier `Data` :

```csharp
using Microsoft.EntityFrameworkCore;

namespace GraphQLFirmApi.Data;

public class AppDbContext : DbContext
{
    public DbSet<Firm> Firms { get; set; }
    public DbSet<Department> Departments { get; set; }
    public DbSet<Employee> Employees { get; set; }

    public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Firm>().HasMany(f => f.Departments).WithOne(d => d.Firm);
        modelBuilder.Entity<Department>().HasMany(d => d.Employees).WithOne(e => e.Work);
        modelBuilder.Entity<Employee>().HasOne(e => e.Manager).WithMany(m => m.Team);
    }
}
```

### 6. Création de la Classe `DataSeeder`

Ajoutez une classe `DataSeeder.cs` dans le dossier `Data` pour générer des données factices :

```csharp
using GraphQLFirmApi.Models;
using Microsoft.EntityFrameworkCore;

namespace GraphQLFirmApi.Data
{
    public class DataSeeder
    {
        public static void SeedData(AppDbContext context)
        {
            if (context.Firms.Any())
            {
                return; // Les données existent déjà
            }

            var firms = new List<Firm>();
            var random = new Random();

            for (int i = 1; i <= 6; i++)
            {
                var firm = new Firm
                {
                    Id = Guid.NewGuid().ToString(),
                    Name = $"Firm {i}",
                    Departments = new List<Department>()
                };

                int departmentsCount = random.Next(3, 6);

                for (int j = 1; j <= departmentsCount; j++)
                {
                    var department = new Department
                    {
                        Id = Guid.NewGuid().ToString(),
                        Name = $"Department {j} of Firm {i}",
                        Location = $"Location {j} of Firm {i}",
                        Employees = new List<Employee>()
                    };

                    int employeesCount = random.Next(10, 21);
                    Employee manager = null;

                    for (int k = 1; k <= employeesCount; k++)
                    {
                        var employee = new Employee
                        {
                            Id = Guid.NewGuid().ToString(),
                            Name = $"Employee {k} of Department {j}",
                            Age = random.Next(25, 60),
                            Email = $"employee{k}@firm{i}.com",
                            Address = $"Address {k} of Department {j}",
                            JobTitle = k == 1 ? "Manager" : $"Employee",
                            DepartmentId = department.Id,
                            ManagerId = k == 1 ? null : manager?.Id
                        };

                        if (k == 1)
                        {
                            manager = employee; // Le premier employé est le manager
                        }
                        else
                        {
                            manager.Team.Add(employee); // Ajoutez l'employé à l'équipe du manager
                        }

                        department.Employees.Add(employee);
                    }

                    firm.Departments.Add(department);
                }

                firms.Add(firm);
            }

            context.Firms.AddRange(firms);
            context.SaveChanges();
        }
    }
}
```

### 7. Configuration de GraphQL dans `Program.cs`

Voici la version correcte de `Program.cs` avec la génération de données intégrée :

```csharp
using GraphQLFirmApi.Data;
using GraphQLFirmApi.GraphQL;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Configure Entity Framework
builder.Services.AddPooledDbContextFactory<AppDbContext>(options => 
    options.UseInMemoryDatabase("FirmDb"));

// Configure GraphQL
builder.Services
    .AddGraphQLServer()
    .AddQueryType<Query>()
    .AddProjections()
    .AddFiltering()
    .AddSorting();

var app = builder.Build();

// Seed data
using (var scope = app.Services.CreateScope())
{
    var dbContextFactory = scope.ServiceProvider.GetRequiredService<IDbContextFactory<AppDbContext>>();
    using (var dbContext = dbContextFactory.CreateDbContext())
    {
        DataSeeder.SeedData(dbContext);
    }
}

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

// Map GraphQL
app.MapGraphQL();

app.Run();
```

### 8. Implémentation des Requêtes GraphQL

Dans le dossier `GraphQL`, créez une classe `Query.cs` :

```csharp
using GraphQLFirmApi.Data;
using GraphQLFirmApi.Models;
using HotChocolate;
using HotChocolate.Data;

namespace GraphQLFirmApi.GraphQL;

public class Query
{
    [UseDbContext(typeof(AppDbContext))]
    [UseProjection]
    [UseFiltering]
    [UseSorting]
    public IQueryable<Firm> GetFirms([ScopedService] AppDbContext context) =>
        context.Firms;

    [UseDbContext(typeof(AppDbContext))]
    [UseProjection]
    [UseFiltering]
    [UseSorting]
    public IQueryable<Department> GetDepartments([ScopedService] AppDbContext context) =>
        context.Departments;

    [UseDbContext(typeof(AppDbContext))]
    [UseProjection]
    [UseFiltering]
    [UseSorting]
    public IQueryable<Employee> GetEmployees([ScopedService] AppDbContext context) =>
        context.Employees;

    [UseDbContext(typeof(AppDbContext))]
    [UseProjection]
    [UseFiltering]
    [UseSorting]
    public IQueryable<Employee> GetTeamMembers(string managerId, [ScopedService] AppDbContext context) =>
        context.Employees.Where(e => e.ManagerId == managerId);
}
```

### 9. Requêtes GraphQL Avancées

Voici cinq requêtes GraphQL plus au moin complexes que vous pouvez tester dans Postman.

#### a. Récupérer les départements d'une entreprise avec le nombre total d'employés par département

```graphql
{
  firms {


    id
    name
    departments {
      id
      name
      location
      employeeCount: employees {
        id
      }
    }
  }
}
```

#### b. Récupérer les managers et leurs équipes avec la possibilité de filtrer par département

```graphql
{
  employees(where: { managerId: { isNull: true }, work: { name: { eq: "IT Department" } } }) {
    id
    name
    jobTitle
    team {
      id
      name
      jobTitle
    }
  }
}
```

#### c. Récupérer les employés d'une entreprise avec leurs managers, même ceux qui n'ont pas de manager

```graphql
{
  employees {
    id
    name
    jobTitle
    manager {
      id
      name
      jobTitle
    }
    work {
      name
    }
  }
}
```

#### d. Récupérer une liste des employés travaillant sous un manager spécifique, regroupés par département

```graphql
{
  employees(where: { managerId: { eq: "managerId" } }) {
    id
    name
    jobTitle
    department {
      id
      name
      employees {
        id
        name
      }
    }
  }
}
```

#### e. Fusionner (Union) les employés de deux départements pour une comparaison des salaires moyens

```graphql
{
  departmentOne: employees(where: { departmentId: { eq: "departmentOneId" } }) {
    id
    name
    jobTitle
    salary
  }
  departmentTwo: employees(where: { departmentId: { eq: "departmentTwoId" } }) {
    id
    name
    jobTitle
    salary
  }
}
```

### 10. Consommer l'API avec Postman

#### a. Configurer la Requête

1. Ouvrez Postman et créez une nouvelle requête.
2. Choisissez `POST` comme méthode HTTP.
3. Entrez l'URL : `https://localhost:5001/graphql` (ou le port approprié).

#### b. Requêtes dans Postman

- Sélectionnez `GraphQL` dans l'onglet `Body`.
- Copiez l'une des requêtes GraphQL ci-dessus et collez-la dans le corps de la requête.
- Cliquez sur "Send".

### Conclusion

Ce tutoriel vous guide pour créer une application Web API en .NET 8 utilisant GraphQL avec HotChocolate, en intégrant une génération de données en mémoire. Le projet est maintenant configuré pour tester des requêtes complexes grâce aux données factices, vous permettant d'explorer pleinement les capacités de GraphQL dans un contexte réaliste.

Pour continuer avec ce projet et exposer les données avec OData en plus de GraphQL, vous devez configurer OData pour fonctionner avec votre Web API. OData (Open Data Protocol) permet de créer des services RESTful plus flexibles en supportant des requêtes dynamiques telles que la sélection de champs, le filtrage, l'ordonnancement, et la pagination.

Voici comment vous pouvez procéder pour exposer les données avec OData dans ce projet.

### 1. Ajouter les Packages OData

Commencez par ajouter les packages NuGet nécessaires pour OData.

```shell
dotnet add package Microsoft.AspNetCore.OData --version 8.0.9
```

### 2. Configurer OData dans `Program.cs`

Ajoutez la configuration OData dans le fichier `Program.cs`. Cela comprend l'ajout des services OData et la configuration des routes pour OData.

Voici comment modifier votre `Program.cs` :

```csharp
using GraphQLFirmApi.Data;
using GraphQLFirmApi.GraphQL;
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.OData;
using Microsoft.OData.ModelBuilder;
using GraphQLFirmApi.Models;

var builder = WebApplication.CreateBuilder(args);

// Configure Entity Framework
builder.Services.AddPooledDbContextFactory<AppDbContext>(options => 
    options.UseInMemoryDatabase("FirmDb"));

// Configure GraphQL
builder.Services
    .AddGraphQLServer()
    .AddQueryType<Query>()
    .AddProjections()
    .AddFiltering()
    .AddSorting();

// Configure OData
builder.Services.AddControllers().AddOData(opt => 
    opt.Select().Filter().OrderBy().Expand().SetMaxTop(100).Count().AddRouteComponents("odata", GetEdmModel()));

var app = builder.Build();

// Seed data
using (var scope = app.Services.CreateScope())
{
    var dbContextFactory = scope.ServiceProvider.GetRequiredService<IDbContextFactory<AppDbContext>>();
    using (var dbContext = dbContextFactory.CreateDbContext())
    {
        DataSeeder.SeedData(dbContext);
    }
}

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

// Map GraphQL
app.MapGraphQL();

// Map OData endpoints
app.MapControllers();

app.Run();

// Define the OData entity data model (EDM)
IEdmModel GetEdmModel()
{
    var builder = new ODataConventionModelBuilder();
    builder.EntitySet<Firm>("Firms");
    builder.EntitySet<Department>("Departments");
    builder.EntitySet<Employee>("Employees");
    return builder.GetEdmModel();
}
```

### 3. Créer les Contrôleurs OData

Pour exposer les entités via OData, vous devez créer des contrôleurs pour chaque entité. Voici comment créer des contrôleurs pour les entités `Firm`, `Department`, et `Employee`.

#### a. Créer le Contrôleur pour `Firm`

Ajoutez un fichier `FirmsController.cs` dans un dossier `Controllers` :

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.OData.Query;
using Microsoft.AspNetCore.OData.Routing.Controllers;
using Microsoft.EntityFrameworkCore;
using GraphQLFirmApi.Data;
using GraphQLFirmApi.Models;

namespace GraphQLFirmApi.Controllers;

public class FirmsController : ODataController
{
    private readonly IDbContextFactory<AppDbContext> _contextFactory;

    public FirmsController(IDbContextFactory<AppDbContext> contextFactory)
    {
        _contextFactory = contextFactory;
    }

    [EnableQuery]
    public IActionResult Get()
    {
        using var context = _contextFactory.CreateDbContext();
        return Ok(context.Firms);
    }

    [EnableQuery]
    public IActionResult Get(string key)
    {
        using var context = _contextFactory.CreateDbContext();
        var firm = context.Firms.Include(f => f.Departments).FirstOrDefault(f => f.Id == key);
        if (firm == null)
        {
            return NotFound();
        }

        return Ok(firm);
    }
}
```

#### b. Créer le Contrôleur pour `Department`

Ajoutez un fichier `DepartmentsController.cs` dans le dossier `Controllers` :

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.OData.Query;
using Microsoft.AspNetCore.OData.Routing.Controllers;
using Microsoft.EntityFrameworkCore;
using GraphQLFirmApi.Data;
using GraphQLFirmApi.Models;

namespace GraphQLFirmApi.Controllers;

public class DepartmentsController : ODataController
{
    private readonly IDbContextFactory<AppDbContext> _contextFactory;

    public DepartmentsController(IDbContextFactory<AppDbContext> contextFactory)
    {
        _contextFactory = contextFactory;
    }

    [EnableQuery]
    public IActionResult Get()
    {
        using var context = _contextFactory.CreateDbContext();
        return Ok(context.Departments);
    }

    [EnableQuery]
    public IActionResult Get(string key)
    {
        using var context = _contextFactory.CreateDbContext();
        var department = context.Departments.Include(d => d.Employees).FirstOrDefault(d => d.Id == key);
        if (department == null)
        {
            return NotFound();
        }

        return Ok(department);
    }
}
```

#### c. Créer le Contrôleur pour `Employee`

Ajoutez un fichier `EmployeesController.cs` dans le dossier `Controllers` :

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.OData.Query;
using Microsoft.AspNetCore.OData.Routing.Controllers;
using Microsoft.EntityFrameworkCore;
using GraphQLFirmApi.Data;
using GraphQLFirmApi.Models;

namespace GraphQLFirmApi.Controllers;

public class EmployeesController : ODataController
{
    private readonly IDbContextFactory<AppDbContext> _contextFactory;

    public EmployeesController(IDbContextFactory<AppDbContext> contextFactory)
    {
        _contextFactory = contextFactory;
    }

    [EnableQuery]
    public IActionResult Get()
    {
        using var context = _contextFactory.CreateDbContext();
        return Ok(context.Employees);
    }

    [EnableQuery]
    public IActionResult Get(string key)
    {
        using var context = _contextFactory.CreateDbContext();
        var employee = context.Employees.Include(e => e.Manager).FirstOrDefault(e => e.Id == key);
        if (employee == null)
        {
            return NotFound();
        }

        return Ok(employee);
    }
}
```

### 4. Tester l'API OData

Maintenant que tout est configuré, vous pouvez tester l'API OData en utilisant Postman ou un navigateur web.

#### a. Récupérer toutes les firms

- URL : `https://localhost:5001/odata/Firms`
- Méthode : GET

#### b. Récupérer une firm par ID

- URL : `https://localhost:5001/odata/Firms('firmId')`
- Méthode : GET

#### c. Filtrer, Ordre, et Sélection

- URL : `https://localhost:5001/odata/Employees?$filter=Age gt 30&$orderby=Name desc&$select=Name,Age,JobTitle`
- Méthode : GET

### Conclusion

Vous avez maintenant une application Web API en .NET 8 qui expose des données via GraphQL et OData. OData vous permet d'offrir une API RESTful plus flexible avec la possibilité de filtrer, trier, et sélectionner dynamiquement les données. Vous pouvez combiner les deux pour offrir des services API riches et robustes qui répondent à différents besoins des clients.
