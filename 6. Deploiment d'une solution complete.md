# Déploiement d'une solution complete

Voici un **tutoriel étape par étape** pour créer un cluster applicatif Kubernetes avec un déploiement d'une application **.NET 8 Web API** (4 réplicas) et un déploiement **MySQL** (2 réplicas).

### 1. Structure du projet

```
/MyNetApp
|-- MyNetApp.csproj
|-- Program.cs
|-- appsettings.json
|-- launchSettings.json
|-- Data
|   |-- ApplicationDbContext.cs
|-- Controllers
|   |-- WeatherController.cs
|-- Migrations
|-- Dockerfile
|-- k8s
    |-- api-deployment.yaml
    |-- api-service.yaml
    |-- mysql-deployment.yaml
    |-- mysql-service.yaml
```

### 2. Fichier `MyNetApp.csproj`

```xml
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />
    <PackageReference Include="MySql.EntityFrameworkCore" Version="8.0.33" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" Version="8.0.0" />
  </ItemGroup>

</Project>
```

### 3. Code Source

#### `Program.cs`

```csharp
var builder = WebApplication.CreateBuilder(args);

// Configuration de la DB
var connectionString = builder.Configuration.GetConnectionString("MySqlConnection");
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseMySql(connectionString, ServerVersion.AutoDetect(connectionString)));

builder.Services.AddControllers();

var app = builder.Build();

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();
app.Run();
```

#### `ApplicationDbContext.cs`

```csharp
using Microsoft.EntityFrameworkCore;

namespace MyNetApp.Data
{
    public class ApplicationDbContext : DbContext
    {
        public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
            : base(options)
        {
        }

        public DbSet<WeatherForecast> WeatherForecasts { get; set; }
    }
}
```

#### `WeatherController.cs`

```csharp
using Microsoft.AspNetCore.Mvc;
using MyNetApp.Data;

namespace MyNetApp.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class WeatherController : ControllerBase
    {
        private readonly ApplicationDbContext _context;

        public WeatherController(ApplicationDbContext context)
        {
            _context = context;
        }

        [HttpGet]
        public IActionResult GetWeatherForecast()
        {
            var forecasts = _context.WeatherForecasts.ToList();
            return Ok(forecasts);
        }
    }
}
```

### 4. Fichiers de configuration

#### `appsettings.json`

```json
{
  "ConnectionStrings": {
    "MySqlConnection": "Server=mysql-service;Database=weatherdb;User=root;Password=my-secret-pw;"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

#### `launchSettings.json`

```json
{
  "profiles": {
    "MyNetApp": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "applicationUrl": "http://localhost:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

### 5. Dockerfile

```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["MyNetApp.csproj", "./"]
RUN dotnet restore "./MyNetApp.csproj"
COPY . .
RUN dotnet build "MyNetApp.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "MyNetApp.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "MyNetApp.dll"]
```

### 6. Kubernetes Configuration

#### `api-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mynetapp-deployment
spec:
  replicas: 4
  selector:
    matchLabels:
      app: mynetapp
  template:
    metadata:
      labels:
        app: mynetapp
    spec:
      containers:
      - name: mynetapp
        image: myregistry/mynetapp:latest
        ports:
        - containerPort: 80
        env:
        - name: ASPNETCORE_ENVIRONMENT
          value: "Development"
```

#### `api-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: api-service
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30001
  selector:
    app: mynetapp
```

#### `mysql-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "my-secret-pw"
        - name: MYSQL_DATABASE
          value: "weatherdb"
        ports:
        - containerPort: 3306
```

#### `mysql-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  type: ClusterIP
  ports:
  - port: 3306
  selector:
    app: mysql
```

### 7. Commandes Kubernetes

Déployer MySQL :

```bash
kubectl apply -f k8s/mysql-deployment.yaml
kubectl apply -f k8s/mysql-service.yaml
```

Déployer l'application .NET 8 Web API :

```bash
kubectl apply -f k8s/api-deployment.yaml
kubectl apply -f k8s/api-service.yaml
```

### 8. Tests

- Accéder à l'API via le NodePort : `http://<NODE-IP>:30001/Weather`
- Vérifiez que les réplicas .NET consomment bien la base de données MySQL
